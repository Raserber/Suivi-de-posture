<!DOCTYPE html>
<html>
   <body>
      <link rel="stylesheet" href="./css/style.css">
      <script src="./libs/three.min.js"></script>
      <script src="./libs/OrbitControls.min.js"></script>
      <script src="./libs/axios.min.js"></script>
      <script src="./libs/mannequin.js"></script>

      <script src="./js/bottomControlConfiguration.js"></script>
      <script src="./js/initVisualPoints.js"></script>
      <script src="./js/jsFunctions.js"></script>

      <div class="panel" style="left = 0;">

         <label><input id="toggle_restrain" type="checkbox" class="toggle"><span>Restrain<br>movements</span></label><br>
         <label><input id="toggle_rightPanel" type="checkbox" class="toggle" checked=""><span>Panel droit</span></label><hr>
         <label><input id="toggle_redPoints" type="checkbox" class="toggle" checked=""><span>red points</span></label><br>
         <label><input id="toggle_posture" type="checkbox" class="toggle"><span>Changement<br>progressif pose</span></label><br>
         <label><input id="toggle_orbitsControls" type="checkbox" class="toggle"><span>Orbits controls</span></label>
      
      </div>

      <div class="panel" id="rightPanel" style="right: 0px; visibility: visible;">
	     <span class="button-group">
			 <button id="debout" class="notButton">Debout</button><br>
			 <button id="assis" class="notButton buttonActivate">Assis</button><br>
			 <button id="allonge" class="notButton">Allongé</button>
      </span></div>
      <script>
         var angleTorse = 0, angleJambes = 0, angleGenoux = 0

         // définition des variables correspondant aux boutons et toggle
         toggle_restrain = document.getElementById("toggle_restrain")
         toggle_panelDroit = document.getElementById("toggle_rightPanel")
         toggle_redPoints = document.getElementById("toggle_redPoints")
         toggle_posture = document.getElementById("toggle_posture")
         toggle_orbitsControls = document.getElementById("toggle_orbitsControls")
         rightPanel = document.getElementById("rightPanel")
         bouton_debout = document.getElementById("debout")
         bouton_assis = document.getElementById("assis")
         bouton_allonge = document.getElementById("allonge")


         // création de la scene Threejs
         createScene();

         scene.add(lfeet1, lfeet2, lfeet3, lfeet4, lfeet5, lfeet6, rfeet1, rfeet2, rfeet3, rfeet4, rfeet5, rfeet6, lleg1, lleg2, rleg1, rleg2, torso1, torso2, pelvis1, pelvis2, head1, head2, head3, lfinger1, rfinger1, genoux1, genoux2, genoux3, genoux4)
   
         // creation d'un objet mannequin
         man = new Male();

         // permet à l'utilisateur de tourner la vue
         var controls = new THREE.OrbitControls(camera, renderer.domElement);

         scene.rotation.y = -1.3
         scene.rotation.x = 0.3

         // fonction d'animation
         function animate(t)
         {

            if (toggle_posture.checked) {
               // changement de posture animé
               man.posture = Mannequin.blend(man.posture, posture(angleTorse, angleJambes, angleGenoux), 0.03)
            }
            else {
               man.posture = posture(angleTorse, angleJambes, angleGenoux)
            }


            // changements liés aux boutons et toggles (./js/jsFunctions.js:45)
            toggle_panelDroit.checked ? rightPanel.style.visibility = "visible" : rightPanel.style.visibility = "hidden"
            changementEtatBoutons(angleTorse, angleJambes)
            toggleRedPoints(toggle_redPoints.checked)
            toggleOrbitsControls(toggle_orbitsControls.checked)

            // boucle relevant les bras si proche du sol
            if (man.l_wrist.point(1, 5, 0).y+29.5 <= 0 || man.l_wrist.point(1, 2, -1.5).y+29.5 <= 0) {
               while (man.l_wrist.point(1, 5, 0).y+29.5 <= 0 || man.l_wrist.point(1, 2, -1.5).y+29.5 <= 0) {
                  man.l_arm.raise   += 0.005
                  man.r_arm.raise   += 0.005
                  man.l_elbow.bend  += man.l_elbow.bend >= 90 ? 0 : 0.01
                  man.r_elbow.bend  += man.r_elbow.bend >= 90 ? 0 : 0.01

               }
            }

            // boucle descendant les bras si loin du sol
            else {
               
               if (man.l_arm.raise > 0) {
                  man.l_arm.raise   -= 0.3 + man.l_arm.raise * 0.005
                  man.r_arm.raise   -= 0.3 + man.r_arm.raise * 0.005
               }

               else if (man.l_elbow.bend > 15) {
                  
                  man.l_elbow.bend  -= 0.6 + man.l_elbow.bend * 0.02
                  man.r_elbow.bend  -= 0.6 + man.r_elbow.bend * 0.02
               }
            }

            

            if (man.l_ankle.bend <= -80) {
               man.l_ankle.bend = man.r_ankle.bend = 0
            }

            if (man.l_ankle.bend >= 84) {
               man.l_ankle.bend = man.r_ankle.bend = -50
            }

            // extraction de la hauteur du point le plus bas du mannequin (./js/bottomControlConfiguration.js)
            var bottom = configBottom()

            // relevage de la position y du mannequin si proche du sol
            man.position.y += (-29.5 - bottom);

            // mets les pieds en position initiale si le talon ou la pointe des pieds ne touchent pas le sol
            
            

            // affichage des points rouges PIEDS
            lfeet1.position.copy(man.l_ankle.point(6, 2, 0));
            lfeet2.position.copy(man.l_ankle.point(-2, 2.5, 0));
            lfeet3.position.copy(man.l_ankle.point(2, 2.5, 2));
            lfeet4.position.copy(man.l_ankle.point(2, 2.5, -2));
            lfeet5.position.copy(man.l_ankle.point(1.35, -0.35, 0));
            lfeet6.position.copy(man.l_ankle.point(-1.35, -0.35, 0));
            rfeet1.position.copy(man.r_ankle.point(6, 2, 0));
            rfeet2.position.copy(man.r_ankle.point(-2, 2.5, 0));
            rfeet3.position.copy(man.r_ankle.point(2, 2.5, 2));
            rfeet4.position.copy(man.r_ankle.point(2, 2.5, -2));
            rfeet5.position.copy(man.r_ankle.point(1.35, -0.35, 0));
            rfeet6.position.copy(man.r_ankle.point(-1.35, -0.35, 0));

            // affichage des points rouges JAMBES
            lleg1.position.copy(man.l_leg.point(2.75, -5, 0));
            lleg2.position.copy(man.l_leg.point(-2.75, -5, 0));
            rleg1.position.copy(man.r_leg.point(2.75, -5, 0));
            rleg2.position.copy(man.r_leg.point(-2.75, -5, 0));

            // affichage des points rouges TORSE
            torso1.position.copy(man.torso.point(3.2, 11.3, 0));
            torso2.position.copy(man.torso.point(-3.5, 13, 0));

            // affichage des points rouges PELVIEN
            pelvis1.position.copy(man.pelvis.point(-5, -0.5, 0));
            pelvis2.position.copy(man.pelvis.point(-1.5, -4, 0));

            // affichage des points rouges TETE
            head1.position.copy(man.head.point(0, 7, 0));
            head2.position.copy(man.head.point(3, 1.75, 0));
            head3.position.copy(man.head.point(-3.5, 4, 0));

            // affichages des points noires MAINS
            lfinger1.position.copy(man.l_wrist.point(1, 5, 0));
            rfinger1.position.copy(man.r_wrist.point(1, 5, 0));
            
            // affichages des points noires MAINS
            genoux1.position.copy(man.l_knee.point(1.25, 0, 0));
            genoux2.position.copy(man.r_knee.point(1.25, 0, 0));
            genoux3.position.copy(man.l_knee.point(-1.25, 0, 0));
            genoux4.position.copy(man.r_knee.point(-1.25, 0, 0));
         }
         
         const socket = new WebSocket("ws://192.168.1.30:1880/ws/angles/3_ED");

         socket.onerror = (e) => {

            // alert("Connexion au serveur perdu, veuillez recharger la page")
         }


         socket.addEventListener("open", (event) => {})
         
         socket.addEventListener("message", (event) => {
            
               angleTorse = searchAndReturnEndDevice(event, 3).angleZ
               angleJambes = searchAndReturnEndDevice(event, 4).angleZ
               angleGenoux = searchAndReturnEndDevice(event, 5).angleZ

            });
         
         angleTorse = 25
         angleJambes = -70
         angleGenoux = -70
      </script>
   </body>
</html>

