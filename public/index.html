<!DOCTYPE html>
<html>
   <body>
      <script src="./libs/three.min.js"></script>
      <script src="./libs/OrbitControls.min.js"></script>
      <script src="./libs/axios.min.js"></script>
      <script src="./libs/mannequin.js"></script>

      <script src="./js/bottomControlConfiguration.js"></script>
      <script src="./js/initVisualPoints.js"></script>
      <script src="./js/jsFunctions.js"></script>
      <script>
         var angleTorse = 0, angleJambes = 0

         // création de la scene Threejs
         createScene();
   
         // creation d'un objet mannequin
         man = new Male();

         // permet à l'utilisateur de tourner la vue
         var controls = new THREE.OrbitControls(camera, renderer.domElement);


         var startTime
         var startAngleTorse
         var startAngleJambes
         var inMove = false
         // fonction d'animation
         function animate(t)
         {
            scene.rotation.y = -1
            scene.rotation.x = 0.5

            // changement de posture animé
            man.posture = Mannequin.blend(man.posture, posture(angleTorse, angleJambes+angleTorse), 0.03)

            // extraction de la hauteur du point le plus bas du mannequin (./js/bottomControlConfiguration.js)
            var bottom = configBottom()

            // boucle relevant les bras si proche du sol
            if (man.l_wrist.point(1, 5, 0).y+29.5 <= 0 || man.l_wrist.point(1, 2, -1.5).y+29.5 <= 0) {
               while (man.l_wrist.point(1, 5, 0).y+29.5 <= 0 || man.l_wrist.point(1, 2, -1.5).y+29.5 <= 0) {
                  man.l_arm.raise   += 0.005
                  man.r_arm.raise   += 0.005
                  man.l_elbow.bend  += man.l_elbow.bend >= 90 ? 0 : 0.01
                  man.r_elbow.bend  += man.r_elbow.bend >= 90 ? 0 : 0.01

               }
            }

            // boucle descendant les bras si loin du sol
            else {
               
               if (man.l_arm.raise > 0) {
                  man.l_arm.raise   -= 0.3 + man.l_arm.raise * 0.005
                  man.r_arm.raise   -= 0.3 + man.r_arm.raise * 0.005
               }

               else if (man.l_elbow.bend > 15) {
                  
                  man.l_elbow.bend  -= 0.6 + man.l_elbow.bend * 0.02
                  man.r_elbow.bend  -= 0.6 + man.r_elbow.bend * 0.02
               }
            }

            // relevage de la position y du mannequin si proche du sol
				man.position.y += (-29.5 - bottom);
         }

         const socket = new WebSocket("ws://192.168.1.30:1880/ws/angles_ED3_ED4");

         socket.addEventListener("open", (event) => {});

         socket.addEventListener("message", (event) => {
            
            angleTorse = searchAndReturnEndDevice(event, 3).angleY
            angleJambes = -searchAndReturnEndDevice(event, 4).angleY

          });

      </script>
   </body>
</html>

