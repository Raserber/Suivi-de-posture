<!DOCTYPE html>
<html>
   <body>
      <script src="./libs/three.min.js"></script>
      <script src="./libs/OrbitControls.min.js"></script>
      <script src="./libs/axios.min.js"></script>
      <script src="./libs/mannequin.js"></script>

      <script src="./js/bottomControlConfiguration.js"></script>
      <script src="./js/initVisualPoints.js"></script>
      <script src="./js/jsFunctions.js"></script>
      <script>
         var angleTorse = 0, angleJambes = 0, anglesGenoux = 0

         // création de la scene Threejs
         createScene();

         scene.add(lfeet1, lfeet2, lfeet3, lfeet4, lfeet5, lfeet6, rfeet1, rfeet2, rfeet3, rfeet4, rfeet5, rfeet6, lleg1, lleg2, rleg1, rleg2, torso1, torso2, pelvis1, pelvis2, head1, head2, head3, lfinger1, rfinger1, genoux1, genoux2, genoux3, genoux4)
   
         // creation d'un objet mannequin
         man = new Male();

         // permet à l'utilisateur de tourner la vue
         var controls = new THREE.OrbitControls(camera, renderer.domElement);

         scene.rotation.y = -1.6
         //scene.rotation.x = 0.5

         // fonction d'animation
         function animate(t)
         {

            // changement de posture animé
            man.posture = Mannequin.blend(man.posture, posture(angleTorse, -(angleJambes+angleTorse), anglesGenoux-angleJambes-angleTorse-angleTorse), 0.03)

            // extraction de la hauteur du point le plus bas du mannequin (./js/bottomControlConfiguration.js)
            var bottom = configBottom()

            // boucle relevant les bras si proche du sol
            if (man.l_wrist.point(1, 5, 0).y+29.5 <= 0 || man.l_wrist.point(1, 2, -1.5).y+29.5 <= 0) {
               while (man.l_wrist.point(1, 5, 0).y+29.5 <= 0 || man.l_wrist.point(1, 2, -1.5).y+29.5 <= 0) {
                  man.l_arm.raise   += 0.005
                  man.r_arm.raise   += 0.005
                  man.l_elbow.bend  += man.l_elbow.bend >= 90 ? 0 : 0.01
                  man.r_elbow.bend  += man.r_elbow.bend >= 90 ? 0 : 0.01

               }
            }

            // boucle descendant les bras si loin du sol
            else {
               
               if (man.l_arm.raise > 0) {
                  man.l_arm.raise   -= 0.3 + man.l_arm.raise * 0.005
                  man.r_arm.raise   -= 0.3 + man.r_arm.raise * 0.005
               }

               else if (man.l_elbow.bend > 15) {
                  
                  man.l_elbow.bend  -= 0.6 + man.l_elbow.bend * 0.02
                  man.r_elbow.bend  -= 0.6 + man.r_elbow.bend * 0.02
               }
            }

            // relevage de la position y du mannequin si proche du sol
            man.position.y += (-29.5 - bottom);

            // affichage des points rouges PIEDS
            lfeet1.position.copy(man.l_ankle.point(6, 2, 0));
            lfeet2.position.copy(man.l_ankle.point(-2, 2.5, 0));
            lfeet3.position.copy(man.l_ankle.point(2, 2.5, 2));
            lfeet4.position.copy(man.l_ankle.point(2, 2.5, -2));
            lfeet5.position.copy(man.l_ankle.point(1.35, -0.35, 0))
            lfeet6.position.copy(man.l_ankle.point(-1.35, -0.35, 0))
            rfeet1.position.copy(man.r_ankle.point(6, 2, 0));
            rfeet2.position.copy(man.r_ankle.point(-2, 2.5, 0));
            rfeet3.position.copy(man.r_ankle.point(2, 2.5, 2));
            rfeet4.position.copy(man.r_ankle.point(2, 2.5, -2));
            rfeet5.position.copy(man.r_ankle.point(1.35, -0.35, 0))
            rfeet6.position.copy(man.r_ankle.point(-1.35, -0.35, 0))

            // affichage des points rouges JAMBES
            lleg1.position.copy(man.l_leg.point(2.75, -5, 0));
            lleg2.position.copy(man.l_leg.point(-2.75, -5, 0));
            rleg1.position.copy(man.r_leg.point(2.75, -5, 0));
            rleg2.position.copy(man.r_leg.point(-2.75, -5, 0));

            // affichage des points rouges TORSE
            torso1.position.copy(man.torso.point(3.2, 11.3, 0));
            torso2.position.copy(man.torso.point(-3.5, 13, 0));

            // affichage des points rouges PELVIEN
            pelvis1.position.copy(man.pelvis.point(-5, -0.5, 0))
            pelvis2.position.copy(man.pelvis.point(-1.5, -4, 0))

            // affichage des points rouges TETE
            head1.position.copy(man.head.point(0, 7, 0))
            head2.position.copy(man.head.point(3, 1.75, 0))
            head3.position.copy(man.head.point(-3.5, 4, 0))

            // affichages des points noires MAINS
            lfinger1.position.copy(man.l_wrist.point(1, 5, 0))
            rfinger1.position.copy(man.r_wrist.point(1, 5, 0))
            
            // affichages des points noires MAINS
            genoux1.position.copy(man.l_knee.point(1.25, 0, 0))
            genoux2.position.copy(man.r_knee.point(1.25, 0, 0))
            genoux3.position.copy(man.l_knee.point(-1.25, 0, 0))
            genoux4.position.copy(man.r_knee.point(-1.25, 0, 0))
         }
         
         const socket = new WebSocket("ws://192.168.1.30:1880/ws/angles/3_ED");

         socket.onerror = (e) => {

            alert("Connexion au serveur perdu, veuillez recharger la page")
         }


         socket.addEventListener("open", (event) => {})
         
         socket.addEventListener("message", (event) => {
            
               angleTorse = searchAndReturnEndDevice(event, 3).angleY
               angleJambes = searchAndReturnEndDevice(event, 4).angleY
               anglesGenoux = searchAndReturnEndDevice(event, 5).angleY

               console.log(angleTorse, angleJambes, anglesGenoux)
            });
      </script>
   </body>
</html>

